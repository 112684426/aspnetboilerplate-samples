<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Using stored Procedure, View And User Defined Function In ABP</title>
</head>

<body>



<h1>Custom Repositories In ASP.NET Boilerplate</h1>
<h3>Introduction</h3>
<p>In this article, i will explain how to create custom repostories in <strong> <a href="https://aspnetboilerplate.com/"> ASP.NET Boilerplate </a></strong> and 
usage of stored procedure, view, user defined functions.</p>
<p>You can download the template from here: <a href="https://aspnetboilerplate.com/Templates>ASP.NET 
Core MVC</strong></a>) that is used for this article from here:
<a href="https://aspnetboilerplate.com/Templates">
https://aspnetboilerplate.com/Templates</a></p>
<p>If you need help with setting up the template: 
<a href="https://aspnetboilerplate.com/Pages/Documents/Zero/Startup-Template-Core">https://aspnetboilerplate.com/Pages/Documents/Zero/Startup-Template-Core</a></p>
<p><img alt="Projects" height="462" src="solutionExplorer.png" width="382" /></p>


<h3>Creating A Custom Repository</h3>



<p>We will create a custom repository to do some basic operations on User entity, using stored procedure, view and user defined function. To implement a custom repository, just derive from your application specific base repository class.</p>

<pre>
    public interface IUserRepository: <strong> IRepository&lt;User, long&gt; </strong>
    {
      ...
      ...
    }
    
    public class UserRepository : <strong>AbpZeroTemplateRepositoryBase&lt;User, long&gt;, IUserRepository </strong>
    {
        private readonly IActiveTransactionProvider _transactionProvider;

        public UserRepository(IDbContextProvider&lt;PhoneBookDbContext&gt; dbContextProvider, IActiveTransactionProvider transactionProvider)
            : base(dbContextProvider)
        {
            _transactionProvider = transactionProvider;
        }
        
        ...
        ...
    }
    
</pre>

<p>That's all! We created the repository and we will implement the functions. But firstly, we have to handle the connection.</p>

<h3>Database Connection</h3>

<p>We will implement these functions in UserRepository class. They are common helper functions and we will use them later.</p>

<pre>
        private DbCommand CreateCommand(string commandText, CommandType commandType, params SqlParameter[] parameters)
        {
            var command = Context.Database.GetDbConnection().CreateCommand();

            command.CommandText = commandText;
            command.CommandType = commandType;
            command.Transaction = GetActiveTransaction();

            foreach (var parameter in parameters)
            {
                command.Parameters.Add(parameter);
            }

            return command;
        }

        private void EnsureConnectionOpen()
        {
            var connection = Context.Database.GetDbConnection();

            if (connection.State != ConnectionState.Open)
            {
                connection.Open();
            }
        }

        private DbTransaction GetActiveTransaction()
        {
            return (DbTransaction)_transactionProvider.GetActiveTransaction(new ActiveTransactionProviderArgs
            {
                {"ContextType", typeof(PhoneBookDbContext) },
                {"MultiTenancySide", MultiTenancySide }
            });
        }
</pre>



<h3>stored Procedure</h3>

<p> Here is a stored procedure call that gets username of all users.</p>

<pre>
        public async Task&lt;List&lt;string&gt;&gt; GetUserNames()
        {
            EnsureConnectionOpen();

            using (var command = CreateCommand("GetUsernames", CommandType.storedProcedure))
            {
                using (var dataReader = await command.ExecuteReaderAsync())
                {
                    var result = new List&lt;string&gt;();

                    while (dataReader.Read())
                    {
                        result.Add(dataReader["UserName"].ToString());
                    }

                    return result;
                }
            }
        }
</pre>
<p>In interface class:</p>
<pre>
    public interface IUserRepository: <strong> IRepository&lt;User, long&gt; </strong>
    {
      ...
      <strong>Task&lt;List&lt;string&gt;&gt; GetUserNames();</strong>
      ...
    }
</pre>

<p>Here is the store procedure that is called:</P>

<pre>
USE [PhoneBookDb]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[GetUsernames] 
AS
BEGIN
	SET NOCOUNT ON;
	SELECT UserName FROM AbpUsers
END
GO
</pre>

<p>Now we implemented the functon that calls stored procedure from database. Let's use it in application service:</p>

<pre>
    public class UserAppService : AsyncCrudAppService&lt;User, UserDto, long, PagedResultRequestDto, CreateUserDto, UserDto&gt;, IUserAppService
    {
        ...
        <strong>private readonly IUserRepository _userRepository;</strong>
		...
		
        public UserAppService(... ... .... , <strong>IUserRepository userRepository</strong>)
            : base(repository)
        {
            ...
            <strong>_userRepository = userRepository</strong>;
        }
        
        ...
        
        <strong> public async Task&lt;List&lt;string&gt;&gt; GetUsers()
        {
            return await _userRepository.GetUserNames();
        }</strong>
        ...
    }
</pre>

<p>Here is an example function that sends a parameter to delete a user</p>

<pre>
        public async Task DeleteUser(EntityDto input)
        {
            var commandText = "EXEC DeleteUserById @id";
            var parameter = new SqlParameter("id", input.Id);
            await Context.Database.ExecuteSqlCommandAsync(commandText,new CancellationToken(), parameter);
        }
</pre>

<p>stored procedure that is called for deletion:</p>

<pre>
USE [PhoneBookDb]
GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[DeleteUserById] 
	@id int  
AS
BEGIN
	SET NOCOUNT ON;
	DELETE FROM AbpUsers WHERE [Id] = @id
END
GO
</pre>


<p>And another example function that sends a parameter to update a user's email address.</p>
<pre>
        public async Task UpdateEmail(UpdateEmailDto input)
        {
            var commandText = "EXEC UpdateEmailById @email, @id";
            var parameterId = new SqlParameter("id", input.Id);
            var parameterEmail = new SqlParameter("email", input.EmailAddress);
            await Context.Database.ExecuteSqlCommandAsync(commandText, new CancellationToken(), parameterEmail, parameterId);
        }
</pre>

<p>Stored procedure that is called for update method:</p>

<pre>
USE [PhoneBookDb]
GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[UpdateEmailById]
@email nvarchar(256),
@id int

AS
BEGIN
	SET NOCOUNT ON;
	UPDATE AbpUsers SET [EmailAddress] = @email WHERE [Id] = @id
END

GO
</pre>


<h3>View</h3>

<p>You can call a view like that:</p>
<pre>
        public async Task&lt;List&lt;string&gt;&gt; GetAdminUsernames()
        {
            EnsureConnectionOpen();
            using (var command = CreateCommand("SELECT * FROM dbo.UserAdminView", CommandType.Text))
            {
                    using (var dataReader = await command.ExecuteReaderAsync())
                    {
                        var result = new List&lt;string&gt;();
                        while (dataReader.Read())
                        {
                            result.Add(dataReader["UserName"].ToString());
                        }
                        return result;
                    }
            }
        }
 </pre>
 
<p>View for this method:</p>

<pre>
SELECT        *
FROM            dbo.AbpUsers
WHERE        (Name = 'admin')
</pre>

 
<h3>User Defined Function</h3>

<p>You can call a User Defined Function like that:</p>

<pre>
        public async Task&lt;GetUserByIdOutput&gt; GetUserById(EntityDto input)
        {
            EnsureConnectionOpen();
            using (var command = CreateCommand("SELECT dbo.GetUsernameById(@id)", CommandType.Text, new SqlParameter("@id", input.Id)))
                {
                    var username = (await command.ExecuteScalarAsync()).ToString();
                    return new GetUserByIdOutput() { Username = username };
                }
            
        }
</pre>

<p>User Defined Function for this method:</p>

<pre>
USE [PhoneBookDb]
GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[GetUsernameById] 
	@id int
)
RETURNS nvarchar(32)
AS
BEGIN
	DECLARE @username nvarchar(32)
	SELECT @username = [UserName] FROM AbpUsers WHERE [ID] = @id
	RETURN @username
END

GO</pre>


<h2>Source On Github</h2>

<p>Source code is published on github: <a href="https://github.com/aspnetboilerplate/aspnetboilerplate-samples/tree/master/storedProcedureDemo"> https://github.com/aspnetboilerplate/aspnetboilerplate-samples/tree/master/storedProcedureDemo </a></p>


</body>



</html>
