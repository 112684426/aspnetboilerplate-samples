<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="tr" http-equiv="Content-Language" />
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Using ASP.NET Core, Entity Framework Core and ASP.NET Boilerplate to Create NLayered Web Application</title>
</head>

<body>

<ul class="download">
	<li><a href="SimpleTaskApp.zip">Download sample application</a> (or see latest on <a href="https://github.com/aspnetboilerplate/aspnetboilerplate-samples/tree/master/SimpleTaskSystem-Core" target="_blank">github)</a></li>
</ul>

<h2>Contents</h2>
<ul>
	<li><a href="#ArticleIntro">Introduction</a></li>
	<li>...</li>
	<li><a href="#ArticleMore">More</a></li>
	<li><a href="#ArticleHistory">Article History</a></li>
</ul>

<h2 id="ArticleIntro">Introduction</h2>

<p>This is second part of the "<em>Using ASP.NET Core, Entity Framework Core and 
ASP.NET Boilerplate to Create NLayered Web Application</em>" article series. See 
other parts:</p>
<ul>
	<li>
	<a href="http://www.codeproject.com/Articles/1115763/Using-ASP-NET-Core-Entity-Framework-Core-and-ASP-N">
	Part I - Using ASP.NET Core, Entity Framework Core and ASP.NET Boilerplate 
	to Create NLayered Web Application</a></li>
	<li>Part II (this one) - Using ASP.NET Core, Entity Framework Core and 
	ASP.NET Boilerplate to Create NLayered Web Application</li>
</ul>

<h2 id="ArticleDevelopApp">Developing the Application</h2>

<h3 id="ArticleCreateTaskEntity">Creating the Person Entity</h3>

<p>I'll add <strong>Person</strong> concept to the application to <strong>assign tasks</strong> to people. So, I 
define a simple <strong>Person entity</strong>:</p>
<pre lang="cs"><strong>[Table(&quot;AppPersons&quot;)]</strong>
public class Person : <strong>AuditedEntity&lt;Guid&gt;</strong>
{
    public const int MaxNameLength = 32;

    [Required]
    [MaxLength(MaxNameLength)]
    public string Name { get; set; }

    public Person()
    {
            
    }

    public Person(string name)
    {
        Name = name;
    }
}</pre>
<p>This time, I set Id (primary key)&nbsp; type as <strong>Guid</strong>, for 
demonstration. I also derived from <strong>AuditedEntity</strong> (which has 
CreationTime, CreaterUserId, LastModificationTime and LastModifierUserId 
properties) instead of base Entity class.</p>
<h3>Relating Person to the Task Entity</h3>
<p>I'm also adding <strong>AssignedPerson</strong> property to the <strong>Task</strong> entity 
(only sharing the changed parts here):</p>
<pre lang="cs">[Table(&quot;AppTasks&quot;)]
public class Task : Entity, IHasCreationTime
{
    //...

<strong>    [ForeignKey(nameof(AssignedPersonId))]
    public Person AssignedPerson { get; set; }
    public Guid? AssignedPersonId { get; set; }</strong>

    public Task(string title, string description = null, <strong>Guid? assignedPersonId = null</strong>)
        : this()
    {
        Title = title;
        Description = description;
        <strong>AssignedPersonId = assignedPersonId;</strong>
    }
}</pre>

<p>AssignedPerson is <strong>optional</strong>. So, as task can be assigned to a 
person or 
can be unassigned.</p>
<h3>Adding Person to DbContext</h3>
<p>Finally, I'm adding new Person entity to the DbContext class:</p>
<pre lang="cs">public class SimpleTaskAppDbContext : AbpDbContext
{
    <strong>public DbSet&lt;Person&gt; People { get; set; }</strong>
    
    //...
}</pre>
<h3>Adding a New Migration for Person Entity</h3>
<p>Now, I'm running the following command in the command line:</p>
<p>
<img alt="dotnet ef migrations add" height="38" src="migration-add-person.png" width="670" /></p>
<p>And it creates a new migration class in the project:</p>
<pre lang="cs">public partial class Added_Person : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.CreateTable(
            name: &quot;AppPersons&quot;,
            columns: table =&gt; new
            {
                Id = table.Column&lt;Guid&gt;(nullable: false),
                CreationTime = table.Column&lt;DateTime&gt;(nullable: false),
                CreatorUserId = table.Column&lt;long&gt;(nullable: true),
                LastModificationTime = table.Column&lt;DateTime&gt;(nullable: true),
                LastModifierUserId = table.Column&lt;long&gt;(nullable: true),
                Name = table.Column&lt;string&gt;(maxLength: 32, nullable: false)
            },
            constraints: table =&gt;
            {
                table.PrimaryKey(&quot;PK_AppPersons&quot;, x =&gt; x.Id);
            });

        migrationBuilder.AddColumn&lt;Guid&gt;(
            name: &quot;AssignedPersonId&quot;,
            table: &quot;AppTasks&quot;,
            nullable: true);

        migrationBuilder.CreateIndex(
            name: &quot;IX_AppTasks_AssignedPersonId&quot;,
            table: &quot;AppTasks&quot;,
            column: &quot;AssignedPersonId&quot;);

        migrationBuilder.AddForeignKey(
            name: &quot;FK_AppTasks_AppPersons_AssignedPersonId&quot;,
            table: &quot;AppTasks&quot;,
            column: &quot;AssignedPersonId&quot;,
            principalTable: &quot;AppPersons&quot;,
            principalColumn: &quot;Id&quot;,
            onDelete: <strong>ReferentialAction.SetNull</strong>);
    }

    //...
}</pre>
<p>I just changed ReferentialAction.Restrict to ReferentialAction.SetNull. It 
does that: if I delete a person, assigned tasks to that person become 
unassigned. This is not important in this demo. But I wanted to show that you 
can change the migration code if you need. Actually, you always review the 
generated code before applying it to the database. After that, we can <strong>
apply migration</strong> to our database:</p>
<p>
<img alt="dotnet ef database update" height="33" src="migration-person-update.png" width="558" /></p>
<p>When we open the database, we can see the new table and columns and add some 
test data:</p>
<p><img alt="Person table" height="79" src="person-table.png" width="668" /></p>
<p>I added a person and assigned to the first task:</p>
<p>
<img alt="Tasks table" height="118" src="tasks-table-with-person.png" width="649" /></p>
<h3>Return Assigned Person in the Task List</h3>
<p>I'll change the <strong>TaskAppService</strong> to return assigned person information. First, 
I'm adding two properties to <strong>TaskListDto</strong>:</p>
<pre lang="cs">[AutoMapFrom(typeof(Task))]
public class TaskListDto : EntityDto, IHasCreationTime
{
    //...

<strong>    public Guid? AssignedPersonId { get; set; }

    public string AssignedPersonName { get; set; }</strong>
}</pre>
<p>And including the Task.AssignedPerson property to the query (just added the 
Include line):</p>
<pre lang="cs">public class TaskAppService : SimpleTaskAppAppServiceBase, ITaskAppService
{
    //...

    public async Task&lt;ListResultOutput&lt;TaskListDto&gt;&gt; GetAll(GetAllTasksInput input)
    {
        var tasks = await _taskRepository
            .GetAll()
            <strong>.Include(t =&gt; t.AssignedPerson)</strong>
            .WhereIf(input.State.HasValue, t =&gt; t.State == input.State.Value)
            .OrderByDescending(t =&gt; t.CreationTime)
            .ToListAsync();

        return new ListResultOutput&lt;TaskListDto&gt;(
            ObjectMapper.Map&lt;List&lt;TaskListDto&gt;&gt;(tasks)
        );
    }
}</pre>
<p>Thus, GetAll method will return Assigned person information with the tasks. 
Since we used AutoMapper, new properties will also be copied to DTO 
automatically.</p>
<h3>Change Unit Test to Test Assigned Person</h3>
<p>At this point, we can change unit tests to see if assigned people are 
retrieved while getting the task list. First, I changed initial test data in the 
TestDataBuilder class to assign a person to a task:</p>
<pre lang="cs">public class TestDataBuilder
{
    //...

    public void Build()
    {
<strong>        var neo = new Person(&quot;Neo&quot;);
        _context.People.Add(neo);
        _context.SaveChanges();</strong>

        _context.Tasks.AddRange(
            new Task(&quot;Follow the white rabbit&quot;, &quot;Follow the white rabbit in order to know the reality.&quot;, <strong>neo.Id</strong>),
            new Task(&quot;Clean your room&quot;) { State = TaskState.Completed }
            );
    }
}</pre>
<p>Then I'm changing TaskAppService_Tests.Should_Get_All_Tasks() method to check 
if one of the retrieved tasks has a person assigned (see the last line added):</p>
<pre lang="cs">[Fact]
public async System.Threading.Tasks.Task Should_Get_All_Tasks()
{
    //Act
    var output = await _taskAppService.GetAll(new GetAllTasksInput());

    //Assert
    output.Items.Count.ShouldBe(2);
    <strong>output.Items.Count(t =&gt; t.AssignedPersonName != null).ShouldBe(1);
</strong>}</pre>
<h3>Show Assigned Person Name in the Task List Page</h3>
<p>Finally, we can change <strong>Tasks\Index.cshtml</strong> to show <strong>
AssignedPersonName</strong>:</p>
<pre lang="xml">@foreach (var task in Model.Tasks)
{
    &lt;li class=&quot;list-group-item&quot;&gt;
        &lt;span class=&quot;pull-right label label-lg @Model.GetTaskLabel(task)&quot;&gt;@L($&quot;TaskState_{task.State}&quot;)&lt;/span&gt;
        &lt;h4 class=&quot;list-group-item-heading&quot;&gt;@task.Title&lt;/h4&gt;
        &lt;div class=&quot;list-group-item-text&quot;&gt;
            @task.CreationTime.ToString(&quot;yyyy-MM-dd HH:mm:ss&quot;)<strong> | @(task.AssignedPersonName ?? L(&quot;Unassigned&quot;))</strong>
        &lt;/div&gt;
    &lt;/li&gt;
}</pre>
<p>When we run the application, we can see it in the task list:</p>
<p>
<img alt="Task list with person name" height="311" src="task-list-assigned-person.png" width="446" /></p>
<h3>New Application Service Method for Task Creation</h3>
<p>We can list tasks, but we don't have a <strong>task creation page</strong> yet. First, adding 
a <strong>Create</strong> method to 
the <strong>ITaskAppService</strong> interface:</p>
<pre lang="cs">public interface ITaskAppService : IApplicationService
{
    //...

    System.Threading.Tasks.Task Create(CreateTaskInput input);
}</pre>
<p>And implementing it in TaskAppService class:</p>
<pre lang="cs">public class TaskAppService : SimpleTaskAppAppServiceBase, ITaskAppService
{
    private readonly IRepository&lt;Task&gt; _taskRepository;

    public TaskAppService(IRepository&lt;Task&gt; taskRepository)
    {
        _taskRepository = taskRepository;
    }

    //...

<strong>    public async System.Threading.Tasks.Task Create(CreateTaskInput input)
    {
        var task = ObjectMapper.Map&lt;Task&gt;(input);
        await _taskRepository.InsertAsync(task);
    }</strong>
}</pre>
<p>Create method automatically <strong>maps</strong> given input to a Task entity and inserting to the 
database using the repository. <strong>CreateTaskInput</strong>
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Data-Transfer-Objects" target="_blank">DTO</a> is like that:</p>
<pre lang="cs">using System;
using System.ComponentModel.DataAnnotations;
using Abp.AutoMapper;

namespace Acme.SimpleTaskApp.Tasks.Dtos
{
    <strong>[AutoMapTo(typeof(Task))]</strong>
    public class CreateTaskInput
    {
        [Required]
        [MaxLength(<strong>Task.MaxTitleLength</strong>)]
        public string Title { get; set; }

        [MaxLength(<strong>Task.MaxDescriptionLength</strong>)]
        public string Description { get; set; }

        public Guid? AssignedPersonId { get; set; }
    }
}</pre>
<p>Configured to map it to Task entity (using AutoMapTo attribute) and added 
data annotations to apply
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Validating-Data-Transfer-Objects" target="_blank">
validation</a>. We used constants from Task entity to use same max lengths.</p>
<h3>Testing Task Creation Service</h3>
<p>I'm adding some integration tests into TaskAppService_Tests class to test the 
Create method:</p>
<pre lang="cs">using Acme.SimpleTaskApp.Tasks;
using Acme.SimpleTaskApp.Tasks.Dtos;
using Shouldly;
using Xunit;
using System.Linq;
using Abp.Runtime.Validation;

namespace Acme.SimpleTaskApp.Tests.Tasks
{
    public class TaskAppService_Tests : SimpleTaskAppTestBase
    {
        private readonly ITaskAppService _taskAppService;

        public TaskAppService_Tests()
        {
            _taskAppService = Resolve&lt;ITaskAppService&gt;();
        }

        //...

        [Fact]
        public async System.Threading.Tasks.Task <strong>Should_Create_New_Task_With_Title</strong>()
        {
            await _taskAppService.Create(new CreateTaskInput
            {
                Title = &quot;Newly created task #1&quot;
            });

            UsingDbContext(context =&gt;
            {
                var task1 = context.Tasks.FirstOrDefault(t =&gt; t.Title == &quot;Newly created task #1&quot;);
                <strong>task1.ShouldNotBeNull();</strong>
            });
        }

        [Fact]
        public async System.Threading.Tasks.Task <strong>Should_Create_New_Task_With_Title_And_Assigned_Person</strong>()
        {
            <strong>var neo = UsingDbContext(context =&gt; context.People.Single(p =&gt; p.Name == &quot;Neo&quot;));
</strong>
            await _taskAppService.Create(new CreateTaskInput
            {
                Title = &quot;Newly created task #1&quot;,
                <strong>AssignedPersonId = neo.Id</strong>
            });

            UsingDbContext(context =&gt;
            {
                var task1 = context.Tasks.FirstOrDefault(t =&gt; t.Title == &quot;Newly created task #1&quot;);
                task1.ShouldNotBeNull();
                <strong>task1.AssignedPersonId.ShouldBe(neo.Id);</strong>
            });
        }

        [Fact]
        public async System.Threading.Tasks.Task <strong>Should_Not_Create_New_Task_Without_Title</strong>()
        {
            await <strong>Assert.ThrowsAsync&lt;AbpValidationException&gt;</strong>(async () =&gt;
            {
                await _taskAppService.Create(new CreateTaskInput
                {
                    Title = null
                });
            });
        }
    }
}</pre>
<p>First test creates a task with a <strong>title</strong>, second one creates a 
task with a <strong>title</strong> and <strong>assigned person</strong>, the 
last one tries to create an <strong>invalid</strong> task to show the <strong>
exception</strong> case.</p>
<p>...</p>

<h2 id="ArticleHistory">Article History</h2>

<ul>
	<li><strong>2016-08-08</strong>: Initial publication.</li>
</ul>

</body>

</html>
